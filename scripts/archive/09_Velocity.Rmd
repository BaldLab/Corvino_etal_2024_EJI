---
title: "Velocity"
author: "Dillon Corvino"
date: "07/03/2022"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: united
    highlight: tango
    df_print: paged
    code_folding: hide
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
---

Built with R version `{r} getRversion()`

## Setup {.tabset}

### Environment

```{r setup, message = FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,  
  eval = TRUE, 
  tidy = TRUE
)

knitr::opts_knit$set(
  root.dir = "../"
)

# Environment Set up
rm(list = ls()) #Clean workspace
cat("\014")     #Clean Console
gc() # Free memory


# Establish working directory
library("rstudioapi")

# Set working directory to source file location
setwd(dirname(getActiveDocumentContext()$path))
setwd("..")

# Create output directories & load custom functions & colour scheme
source("scripts/Setup.R", local = knitr::knit_global())

# pipeline variables
long.compute <- FALSE

```


### Reading data

```{r reading_data}
# Read in CD8 only dataset
reduced.seurat <- LoadH5Seurat("saves/reduced_seurat.h5Seurat")
Idents(reduced.seurat) <- reduced.seurat@meta.data$Clusters_l1
DefaultAssay(reduced.seurat) <- "integrated"
```

### Loading R packages
```{r}
library(Seurat)
library(tidyverse)
require(ggplot2)
```

### Setting up python environment
```{r establish_python_env}

# load reticulate
require(reticulate) 

# list conda envs
reticulate::conda_list(conda = "auto")

# create new conda env if not already established
reticulate::conda_create(envname = "velocity")
reticulate::use_condaenv(condaenv = "velocity")
reticulate::conda_install(envname = "velocity",
                         packages = c("anndata", "igraph", "Numpy==1.24", 
                                      "matplotlib", "rpy2", "scanpy", 
                                      "scipy", "scvelo", "sklearn",
                                      "velocyto", "cellrank", "deepvelo"))



#use_python(python = "/Users/timnoahkempchen/Library/r-miniconda/envs/r-reticulate/bin/python", required = T)
#reticulate::use_condaenv(condaenv = "./Library/r-miniconda/envs/r-reticulate/lib/python3.9/",
    #                     required = T)

```

### Loading python packages
```{python}
install igraph
import anndata
import igraph
import matplotlib
import matplotlib.pyplot as plt
import numpy as np
import rpy2.robjects as robj
import scanpy as sc

import scipy
import scipy.optimize
import scvelo as scv
import sklearn
import velocyto as vcy
import cellrank as cr
import deepvelo as dv

from collections import Counter
from IPython.core.display import display, HTML
from numpy_groupies import aggregate, aggregate_np
from rpy2.robjects.packages import importr
from sklearn.decomposition import PCA
from sklearn.neighbors import NearestNeighbors
from scipy.spatial.distance import pdist, squareform
```

### Figure params
```{python}
sc.set_figure_params(dpi=300, dpi_save=300,figsize=(6, 4), color_map = 'viridis_r',)
sc.settings.verbosity = 1
sc.logging.print_header()
```

## Prepare dataset for velocity {.tabset}


### Subset dataset by condition

```{r}

head(CD8.seurat@meta.data)

# untreated dataset
US.CD8.seurat <- subset(CD8.seurat, 
                        subset = condition %in% c("US"))

DimPlot(US.CD8.seurat,
        reduction = "umap") +
  ggtitle("untreated cells")

# treated dataset
Stim.CD8.seurat <- subset(CD8.seurat,
                          subset = condition %in% c("Stim"))

DimPlot(Stim.CD8.seurat, 
        reduction = "umap") +
  ggtitle("stimulated cells")


```


### Export information for velocity analysis

```{r}


output.dir <- "results/Manuscript/Figure3/"

if(!dir.exists(paste0(output.dir))){
  dir.create(paste0(output.dir), 
             recursive = T)
}



write.csv(Cells(CD8.seurat), 
          file = paste0(output.dir, "cellID_obs.csv"), row.names = FALSE)

write.csv(Embeddings(CD8.seurat, reduction = "umap"), file = paste0(output.dir, "cell_embeddings.csv"))

write.csv(paste0("Cluster_",CD8.seurat@meta.data$Clusters_l1), file = paste0(output.dir, "clusters.csv"))


# untreated

output.dir <- "results/Manuscript/Figure3/US/"

if(!dir.exists(paste0(output.dir))){
  dir.create(paste0(output.dir), 
             recursive = T)
}


write.csv(Cells(US.CD8.seurat), 
          file = paste0(output.dir, "cellID_obs.csv"), row.names = FALSE)

write.csv(Embeddings(US.CD8.seurat, reduction = "umap"), file = paste0(output.dir, "cell_embeddings.csv"))

write.csv(paste0("Cluster_",US.CD8.seurat@meta.data$Clusters_l1), file = paste0(output.dir, "clusters.csv"))



# stimulated

output.dir <- "results/Manuscript/Figure3/Stimulated/"

if(!dir.exists(paste0(output.dir))){
  dir.create(paste0(output.dir), 
             recursive = T)
}


write.csv(Cells(Stim.CD8.seurat), 
          file = paste0(output.dir, "cellID_obs.csv"), row.names = FALSE)

write.csv(Embeddings(Stim.CD8.seurat, reduction = "umap"), file = paste0(output.dir, "cell_embeddings.csv"))

write.csv(paste0("Cluster_",Stim.CD8.seurat@meta.data$Clusters_l1), file = paste0(output.dir, "clusters.csv"))

```


## Run scVelo - unstimulated {.tabset}


### prepare python settings
```{python}

sc.settings.figdir = 'results/Manuscript/Figure3/US/'
scv.settings.figdir = 'results/Manuscript/Figure3/US/'
cr.settings.figdir = 'results/Manuscript/Figure3/US/'
scv.settings.set_figure_params('scvelo') 
cr.settings.set_figure_params('scvelo') 


```

### Read in data
```{python}

GEX1 = anndata.read('data/velocity/preprocessing_velocity/kb_count/GEX1/counts_unfiltered/adata.h5ad')
GEX2 = anndata.read('data/velocity/preprocessing_velocity/kb_count/GEX2/counts_unfiltered/adata.h5ad')
GEX3 = anndata.read('data/velocity/preprocessing_velocity/kb_count/GEX3/counts_unfiltered/adata.h5ad')
GEX4 = anndata.read('data/velocity/preprocessing_velocity/kb_count/GEX4/counts_unfiltered/adata.h5ad')

#scv.pl.proportions(GEX1, save="results/Manuscript/Figure3/untreated_scvelo_prop_gex1.png")

#scv.pl.proportions(GEX2,save="results/Manuscript/Figure3/untreated_scvelo_prop_gex2.png")

```

### Filter data to match seurat object and add metadata
```{python}
import pandas as pd
# combine untreated samples
GEX1.obs['sample'] = 'S1'
GEX2.obs['sample'] = 'S2'

GEX1.obs['bcs'] = GEX1.obs.index
GEX2.obs['bcs'] = GEX2.obs.index

GEX1.obs.index = GEX1.obs['sample'] + "_" + GEX1.obs['bcs']  + "-1"
GEX2.obs.index = GEX2.obs['sample'] + "_" + GEX2.obs['bcs']  + "-1"


sc_untreated = GEX1.concatenate(GEX2,index_unique=None)

# combine untreated samples
GEX3.obs['sample'] = 'S3'
GEX4.obs['sample'] = 'S4'

GEX3.obs['bcs'] = GEX3.obs.index
GEX4.obs['bcs'] = GEX4.obs.index

GEX3.obs.index = GEX3.obs['sample'] + "_" + GEX3.obs['bcs']  + "-1"
GEX4.obs.index = GEX4.obs['sample'] + "_" + GEX4.obs['bcs']  + "-1"


sc_treated = GEX3.concatenate(GEX4,index_unique=None)

sc_all = sc_treated.concatenate(sc_untreated,index_unique=None)

scv.pl.proportions(sc_all, save="results/Manuscript/Figure3/sc_all_scvelo_prop.png")


# filter for cell IDs from seurat 
sample_obs_all = pd.read_csv("results/Manuscript/Figure3/cellID_obs.csv")

sc_all = sc_all[np.isin(sc_all.obs.index,sample_obs_all["x"])].copy()
sc_all


# add UMAP coordinates
umap_all = pd.read_csv("results/Manuscript/Figure3/cell_embeddings.csv")

sc_all.obsm['X_umap'] = umap_all.iloc[:,1:].values

# add cluster info
cluster_all = pd.read_csv("results/Manuscript/Figure3/clusters.csv")
sc_all.obs['clusters'] = cluster_all.iloc[:,1:].values

```

### spliced to unspliced proportions
```{python}

sc.pl.embedding(sc_all,
basis = 'umap',
color ="clusters",
save = "_scvelo_clusters.png") 

# typically have between 10%-25% of unspliced molecules containing intronic sequences
scv.pl.proportions(sc_all,
save = "results/Manuscript/Figure3/US/scvelo_prop.png")

```

### General overview of dataset
```{r}
p1 <- py$sc_all$obs  %>% as_tibble(rownames = "cell_ids")  %>%
  mutate(UMAP1=py$sc_all$obsm["X_umap"][,1],
         UMAP2=py$sc_all$obsm["X_umap"][,2]) %>%
  mutate(clusters=as.factor(py$sc_all$obs$clusters)) %>%
  ggplot(aes(UMAP1,UMAP2,color=clusters)) +
  geom_point(size=.5) +
  theme_classic() +
  scale_color_manual(values = pals::cols25()) +
  guides(color = guide_legend(override.aes = list(size = 2) )) 

ggsave(plot = p1,width = 10,height = 6,filename = "results/Manuscript/Figure3/US/umap_scvelo_clusters.png")
p1


p2 <- py$sc_all$obs  %>% as_tibble(rownames = "cell_ids")  %>%
  mutate(UMAP1=py$sc_all$obsm["X_umap"][,1],
         UMAP2=py$sc_all$obsm["X_umap"][,2]) %>%
  mutate(clusters=as.factor(py$sc_all$obs$clusters)) %>%
  ggplot(aes(UMAP1,UMAP2,color=sample)) +
  geom_point(size=.5) +
  theme_classic() +
  scale_color_manual(values = pals::cols25()) +
  guides(color = guide_legend(override.aes = list(size = 2) )) 

ggsave(plot = p2,width = 10,height = 6,filename = "results/Manuscript/Figure3/US/umap_scvelo_samples.png")
p2



p3 <- py$sc_all$obs  %>% as_tibble(rownames = "cell_ids")  %>%
  mutate(UMAP1=py$sc_all$obsm["X_umap"][,1],
         UMAP2=py$sc_all$obsm["X_umap"][,2]) %>%
  mutate(clusters=as.factor(py$sc_all$obs$clusters)) %>%
  group_by(clusters,sample) %>%
  tally() %>%
  ggplot(aes(clusters,n,fill=sample)) +
  geom_bar(stat="identity",position = "dodge") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45,hjust=1)) +
  scale_fill_manual(values = pals::cols25())  

ggsave(plot = p3,width = 10,height = 6, filename = "results/Manuscript/Figure3/US/clusters.png")
p3


p4 <- py$sc_all$obs  %>% as_tibble(rownames = "cell_ids")  %>%
  mutate(UMAP1=py$sc_all$obsm["X_umap"][,1],
         UMAP2=py$sc_all$obsm["X_umap"][,2]) %>%
  mutate(clusters=as.factor(py$sc_all$obs$clusters)) %>%
  group_by(clusters,sample) %>%
  tally() %>%
  ggplot(aes(clusters,n,fill=sample)) +
  geom_bar(stat="identity",position = "fill") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45,hjust=1)) +
  scale_fill_manual(values = pals::cols25())  +
  scale_y_continuous(labels = scales::percent) +
  labs(y="Percentage of cluster")

ggsave(plot = p4,width = 10,height = 6,filename = "results/Manuscript/Figure3/US/clusters_perc.png")
p4




```



### Preprocess data scvelo
```{python}

# conda install pandas=1.3.5

# Filter genes and normalise
scv.pp.filter_and_normalize(sc_all)
sc_all

# calculate first and second order moments
scv.pp.moments(sc_all)
sc_all

## Estimate RNA velocity
# required for dynamical modeling (not for deterministic)
scv.tl.recover_dynamics(sc_all, n_jobs = 12) 
scv.tl.velocity(sc_all, mode = "dynamical")

# estimate cell-to-cell transition probabilities for projecting into lower-dim space
scv.tl.velocity_graph(sc_all, n_jobs = 12)

# save data
sc_all.write('saves/sc_all_velocity.h5ad')

```


### read in data
```{python}
# save velocity data
#sc_untreated = anndata.read('saves/sc_untreated_velocity.h5ad')


scv.pl.velocity_embedding_stream(sc_all, 
basis = 'umap',
color = "clusters",
legend_fontsize = 6,
min_mass = 3, 
density = 3 , 
save = "sc_velo_umap_velocity.png")



# run DeepVelo using the default configs
trainer = dv.train(sc_all, dv.Constants.default_configs)
# this will train the model and predict the velocity vectore. The result is stored in adata.layers['velocity']. You can use trainer.model to access the model.

# estimate cell-to-cell transition probabilities for projecting into lower-dim space
scv.tl.velocity_graph(sc_all, n_jobs = 12)


scv.pl.velocity_embedding_stream(sc_all, 
basis = 'umap',
color = "clusters",
legend_fontsize = 6,
min_mass = 3, 
density = 3 , 
save = "sc_velo_umap_velocity_deepvelo.png")


# save data
sc_all.write('saves/sc_untreated_velocity_deepvelo.h5ad')



```


```{python}
scv.pl.velocity_embedding_stream(sc_all, 
basis = 'umap',
color = "clusters",
legend_fontsize = 6,
min_mass = 3, 
density = 3 , 
save = "sc_velo_umap_velocity.png")


scv.pl.velocity_embedding_stream(sc_all, 
basis = 'umap',
color = "clusters",
legend_fontsize = 6,
save = "sc_velo_umap_velocity2.png")


scv.pl.velocity_embedding_grid(sc_all,
basis = 'umap', 
color = "clusters",
legend_fontsize = 6,
min_mass = 3, 
arrow_length = 2 ,
save = "sc_velo_umap_velocity_grid.png")


scv.pl.velocity_embedding(sc_all, 
arrow_length = 3, 
arrow_size = 2,
dpi = 300,
save = "scvelo_velocity_embedding.png")

```



### Edited up to here 

### Identify important genes
```{python}


scv.tl.rank_velocity_genes(sc_all, groupby = 'clusters', min_corr=.3)

df = scv.DataFrame(sc_all.uns['rank_velocity_genes']['names'])
df["Cluster_Type_I_IFN"].head(5)




scv.pl.velocity(sc_all, ['NKG7',  'GZMA', 'CD226', 'TOX'], ncols=2)



scv.pl.velocity(sc_all, ['ENSG00000126709.16'], ncols=1,save="scvelo_gene_dynamics.png")

scv.pl.scatter(sc_all, 'ENSG00000126709.16', color=['clusters', 'velocity'],
               add_outline='Type_I_IFN, Cytotoxic', save="/work_dir/results/figures/untreated/scvelo_gene_dynamics_ifi6.png")

```

```{r}
write_csv(py$df, "/Volumes/Work/IEO/HNSCC_Descriptive/results/Manuscript/Figure3/US/rank_velocity_genes_df.csv")
```


```{python}



```

### Add gene annotation
```{r}

gene_anno <- read_tsv(file = "data/velocity/preprocessing_velocity/kb_ref/t2g.txt",
                      col_names = c("transcript_id","gene_id","gene_symbol")) %>% select(2:3) %>% distinct() 

gene_anno <- data.frame(row.names = gene_anno$gene_id, 
                        symbol = gene_anno$gene_symbol)

untreated_gene_dynamics




untreated_gene_dynamics <- py$df
rownames(untreated_gene_dynamics) <- 1:nrow(untreated_gene_dynamics)

untreated_gene_dynamics_anno <- as.data.frame(lapply(untreated_gene_dynamics, function(x) gene_anno[match(x,rownames(gene_anno)),"symbol"]))

```

```{python}
kwargs = dict(frameon=False, size=10, linewidth=1.5,
              add_outline='Type_I_IFN, Cytotoxic')

ifn_to_plot = ["ENSG00000147443.13","ENSG00000109943.9","ENSG00000162692.12","ENSG00000117090.15","ENSG00000125726.11","ENSG00000137265.15","ENSG00000163599.17"]
# DOK2, CRTAM, VCAM1,SLAMF1, CD70, IRF4, CTLA4

scv.pl.scatter(sc_untreated, ifn_to_plot, ylabel='Type_I_IFN', **kwargs,save="scvelo_gene_dynamics_Type_I_IFN.png")
```


```{python}
scv.tl.velocity_confidence(sc_untreated)
keys = 'velocity_length', 'velocity_confidence'
scv.pl.scatter(sc_untreated, c=keys, cmap='coolwarm', perc=[5, 95], save="velocity_confidence.png")

df = sc_untreated.obs.groupby('clusters')[keys].mean().T
```




```{r,fig.width=10,fig.height=3}
py$sc_untreated$obs %>% as_tibble() %>% 
  select(clusters,velocity_length, velocity_confidence) %>%
  group_by(clusters) %>%
  summarise(across(everything(),mean)) %>%
  pivot_longer(cols = -clusters) %>%
  group_by(name) %>% 
  mutate(scaled=scale(value)) %>%
  ggplot(aes(x=clusters,y=name, fill=scaled)) +
  geom_tile() + 
  scale_fill_distiller(palette = "RdYlBu") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45,hjust=1)) 
```



```{python}
x, y = scv.utils.get_cell_transitions(sc_untreated, basis='umap', starting_cell=1)
ax = scv.pl.velocity_graph(sc_untreated, c='lightgrey', edge_width=.05, show=False)
ax = scv.pl.scatter(sc_untreated, x=x, y=y, s=120, c='ascending', cmap='gnuplot', ax=ax,save="_cell_fate.png")

```


```{python}
scv.tl.velocity_pseudotime(sc_untreated)
scv.pl.scatter(sc_untreated, color='velocity_pseudotime', cmap='gnuplot',save="velocity_pseudotime.png")

```

```{python}
# this is needed due to a current bug - bugfix is coming soon.
sc_untreated.uns['neighbors']['distances'] = sc_untreated.obsp['distances']
sc_untreated.uns['neighbors']['connectivities'] = sc_untreated.obsp['connectivities']

scv.tl.paga(sc_untreated, groups='clusters')
df = scv.get_df(sc_untreated, 'paga/transitions_confidence', precision=2).T
df.style.background_gradient(cmap='Blues').format('{:.2g}')

scv.pl.paga(sc_untreated, basis='umap', size=50, alpha=.1,
            min_edge_width=2, node_size_scale=1.5,save="paga_velocity.png")
```




## Cell rank

```{python}
sc_all = sc.read_h5ad("/Volumes/Work/IEO/HNSCC_Descriptive/saves/sc_all_velocity.h5ad")

from cellrank.tl.kernels import VelocityKernel
vk = VelocityKernel(sc_all)
vk.compute_transition_matrix()
print(vk)

from cellrank.tl.kernels import ConnectivityKernel
ck = ConnectivityKernel(sc_all).compute_transition_matrix()

combined_kernel = 0.8 * vk + 0.2 * ck
from cellrank.tl.estimators import GPCCA

g = GPCCA(combined_kernel)
print(g)
g.compute_schur(n_components=20)
g.plot_spectrum(save="/Volumes/Work/IEO/HNSCC_Descriptive/results/Manuscript/Figure3/Velocity_wholedataset/cellrank/cellrank_schur_untreated.png")

g.compute_macrostates(n_states=4, cluster_key="clusters")
g.plot_macrostates(save="/Volumes/Work/IEO/HNSCC_Descriptive/results/Manuscript/Figure3/Velocity_wholedataset/cellrank/cellrank_macrostates.png")
g.plot_macrostates(same_plot=False,save="/Volumes/Work/IEO/HNSCC_Descriptive/results/Manuscript/Figure3/Velocity_wholedataset/cellrank/cellrank_macrostates_sep.png")
g.plot_macrostates(discrete=True,save="/Volumes/Work/IEO/HNSCC_Descriptive/results/Manuscript/Figure3/Velocity_wholedataset/cellrank/cellrank_macrostates_discrete.png")


```

```{python}
g.set_terminal_states_from_macrostates()
g.compute_absorption_probabilities()
g.plot_absorption_probabilities(save="cellrank_untreated_absorption_probabilities.png")

g.compute_absorption_probabilities(time_to_absorption="all")
sc_untreated.obs["mean_time_to_absorption"] = g.absorption_times['Cluster_Exhausted_2, Cluster_Exhausted_1, Cluster_Naive_like_2_SC, Cluster_Cytotoxic, Cluster_Type_I_IFN mean']
scv.pl.scatter(sc_untreated, color="mean_time_to_absorption",save="cellrank_absorption_time_untreated.png")

```



```{python}
cr.pl.circular_projection(sc_untreated, keys="clusters", legend_loc="right",save="cellrank_circular_projection.png")
```



# Cell Rank tutorial
```{python}
import cellrank as cr

cr.tl.terminal_states(sc_all, cluster_key="clusters", weight_connectivities=0.2)
cr.pl.terminal_states(sc_all)

cr.tl.initial_states(sc_all, cluster_key="clusters")
cr.pl.initial_states(sc_all, discrete=True)

cr.tl.lineages(sc_all)
cr.pl.lineages(sc_all, same_plot=False)
```

















## scVelo - Stimulated {.tabset}


# Run scVelo - Stimulated dataset
```{python}
sc.settings.figdir = 'results/Manuscript/Figure3/Stim/'
scv.settings.figdir = 'results/Manuscript/Figure3/Stim/'
cr.settings.figdir = 'results/Manuscript/Figure3/Stim/'
scv.settings.set_figure_params('scvelo') 
cr.settings.set_figure_params('scvelo') 

GEX3 = anndata.read('/work_dir/results/preprocessing_velocity/kb_count/GEX3/counts_unfiltered/adata.h5ad')
GEX4 = anndata.read('/work_dir/results/preprocessing_velocity/kb_count/GEX4/counts_unfiltered/adata.h5ad')
```


```{python}
scv.pl.proportions(GEX3,save="/work_dir/results/figures/treated/scvelo_prop_gex3.png")
scv.pl.proportions(GEX4,save="/work_dir/results/figures/treated/scvelo_prop_gex4.png")

```


```{python}
import pandas as pd
# combine untreated samples
GEX3.obs['sample'] = 'S3'
GEX4.obs['sample'] = 'S4'

GEX3.obs['bcs'] = GEX3.obs.index
GEX4.obs['bcs'] = GEX4.obs.index

GEX3.obs.index = GEX3.obs['sample'] + "_" + GEX3.obs['bcs']  + "-1"
GEX4.obs.index = GEX4.obs['sample'] + "_" + GEX4.obs['bcs']  + "-1"


sc_treated = GEX3.concatenate(GEX4,index_unique=None)

scv.pl.proportions(sc_treated,save="/work_dir/results/figures/treated/scvelo_prop.png")


# filter for cell IDs from seurat 
sample_obs_treated = pd.read_csv("/work_dir/results/exports/seurat_treated/cellID_obs.csv")

sc_treated = sc_treated[np.isin(sc_treated.obs.index,sample_obs_treated["x"])].copy()
sc_treated
```



```{python}
# add UMAP coordinates
umap_treated = pd.read_csv("/work_dir/results/exports/seurat_treated/cell_embeddings.csv")

sc_treated.obsm['X_umap'] = umap_treated.iloc[:,1:].values

# add cluster info
cluster_treated = pd.read_csv("/work_dir/results/exports/seurat_treated/clusters.csv")
sc_treated.obs['clusters'] = cluster_treated.iloc[:,1:].values

sc.pl.embedding(sc_treated,basis='umap',color ="clusters",save="_scvelo_clusters.png") 
scv.pl.proportions(sc_treated,save="/work_dir/results/figures/treated/scvelo_prop.png")

```


```{r}
p1 <- py$sc_treated$obs  %>% as_tibble(rownames = "cell_ids")  %>%
  mutate(UMAP1=py$sc_treated$obsm$X_umap[,1],
         UMAP2=py$sc_treated$obsm$X_umap[,2]) %>%
  mutate(clusters=as.factor(py$sc_treated$obs$clusters)) %>%
  ggplot(aes(UMAP1,UMAP2,color=clusters)) +
  geom_point(size=.5) +
  theme_classic() +
  scale_color_manual(values = pals::cols25()) +
  guides(color = guide_legend(override.aes = list(size = 2) )) 

ggsave(plot = p1,width = 10,height = 6,filename = "/work_dir/results/figures/treated/umap_scvelo_clusters.png")
p1


p2 <- py$sc_treated$obs  %>% as_tibble(rownames = "cell_ids")  %>%
  mutate(UMAP1=py$sc_treated$obsm$X_umap[,1],
         UMAP2=py$sc_treated$obsm$X_umap[,2]) %>%
  mutate(clusters=as.factor(py$sc_treated$obs$clusters)) %>%
  ggplot(aes(UMAP1,UMAP2,color=sample)) +
  geom_point(size=.5) +
  theme_classic() +
  scale_color_manual(values = pals::cols25()) +
  guides(color = guide_legend(override.aes = list(size = 2) )) 

ggsave(plot = p2,width = 10,height = 6,filename = "/work_dir/results/figures/treated/umap_scvelo_samples.png")
p2



p3 <- py$sc_treated$obs  %>% as_tibble(rownames = "cell_ids")  %>%
  mutate(UMAP1=py$sc_treated$obsm$X_umap[,1],
         UMAP2=py$sc_treated$obsm$X_umap[,2]) %>%
  mutate(clusters=as.factor(py$sc_treated$obs$clusters)) %>%
  group_by(clusters,sample) %>%
  tally() %>%
  ggplot(aes(clusters,n,fill=sample)) +
  geom_bar(stat="identity",position = "dodge") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45,hjust=1)) +
  scale_fill_manual(values = pals::cols25())  

ggsave(plot = p3,width = 10,height = 6,filename = "/work_dir/results/figures/treated/clusters.png")
p3


p4 <- py$sc_treated$obs  %>% as_tibble(rownames = "cell_ids")  %>%
  mutate(UMAP1=py$sc_treated$obsm$X_umap[,1],
         UMAP2=py$sc_treated$obsm$X_umap[,2]) %>%
  mutate(clusters=as.factor(py$sc_treated$obs$clusters)) %>%
  group_by(clusters,sample) %>%
  tally() %>%
  ggplot(aes(clusters,n,fill=sample)) +
  geom_bar(stat="identity",position = "fill") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45,hjust=1)) +
  scale_fill_manual(values = pals::cols25())  +
  scale_y_continuous(labels = scales::percent) +
  labs(y="Percentage of cluster")

ggsave(plot = p4,width = 10,height = 6,filename = "/work_dir/results/figures/treated/clusters_perc.png")
p4




```




```{python}
# conda install pandas=1.3.5
scv.pp.filter_and_normalize(sc_treated)
sc_treated
scv.pp.moments(sc_treated)
sc_treated
scv.tl.recover_dynamics(sc_treated)
scv.tl.velocity(sc_treated, mode = "dynamical")
scv.tl.velocity_graph(sc_treated)


```



```{python}
# save velocity data
sc_treated.write('/work_dir/results/exports/seurat_treated/sc_treated_velocity.h5ad')
#sc_treated = anndata.read('/work_dir/results/exports/seurat_treated/sc_treated_velocity.h5ad')


```

```{python}
scv.pl.velocity_embedding_stream(sc_treated, basis = 'umap',color="clusters",
legend_fontsize=6,min_mass=3, density=3 , save="sc_velo_umap_velocity.png")

scv.pl.velocity_embedding_grid(sc_treated, basis='umap', color="clusters",
legend_fontsize=6,min_mass=3, arrow_length =2 ,save="sc_velo_umap_velocity_grid.png")


```



```{python}

scv.pl.velocity_embedding(sc_treated, arrow_length=3, arrow_size=2, dpi=300,save="scvelo_velocity_embedding.png")


```


```{python}

scv.pl.velocity(sc_treated, ['ENSG00000126709.16'], ncols=2,save="/work_dir/results/figures/treated/scvelo_gene_dynamics.png")

scv.pl.scatter(sc_treated, 'ENSG00000126709.16', color=['clusters', 'velocity'],
               add_outline='Type_I_IFN, Cytotoxic', save="/work_dir/results/figures/treated/scvelo_gene_dynamics_ifi6.png")

```

```{python}
scv.tl.rank_velocity_genes(sc_treated, groupby='clusters', min_corr=.3)

df = scv.DataFrame(sc_treated.uns['rank_velocity_genes']['names'])
df["Cluster_Type_I_IFN"].head(5)

```




```{r}
gene_anno <- read_tsv(file = "/work_dir/results/preprocessing_velocity/kb_ref/t2g.txt",
                      col_names = c("transcript_id","gene_id","gene_symbol")) %>% select(2:3) %>% distinct() 

gene_anno <- data.frame(row.names = gene_anno$gene_id,symbol=gene_anno$gene_symbol)


treated_gene_dynamics <- py$df
rownames(treated_gene_dynamics) <- 1:nrow(treated_gene_dynamics)

treated_gene_dynamics_anno <- as.data.frame(lapply(treated_gene_dynamics, function(x) gene_anno[match(x,rownames(gene_anno)),"symbol"]))

```

```{python}
kwargs = dict(frameon=False, size=10, linewidth=1.5,
              add_outline='Type_I_IFN, Cytotoxic')

ifn_to_plot = ["ENSG00000147443.13","ENSG00000109943.9","ENSG00000162692.12","ENSG00000117090.15","ENSG00000125726.11","ENSG00000137265.15","ENSG00000163599.17"]
# DOK2, CRTAM, VCAM1,SLAMF1, CD70, IRF4, CTLA4

scv.pl.scatter(sc_treated, ifn_to_plot, ylabel='Type_I_IFN', **kwargs,save="scvelo_gene_dynamics_Type_I_IFN.png")
```


```{python}
scv.tl.velocity_confidence(sc_treated)
keys = 'velocity_length', 'velocity_confidence'
scv.pl.scatter(sc_treated, c=keys, cmap='coolwarm', perc=[5, 95], save="velocity_confidence.png")

df = sc_treated.obs.groupby('clusters')[keys].mean().T
```




```{r,fig.width=10,fig.height=3}
p1 <- py$sc_treated$obs %>% as_tibble() %>% 
  select(clusters,velocity_length, velocity_confidence) %>%
  group_by(clusters) %>%
  summarise(across(everything(),mean)) %>%
  pivot_longer(cols = -clusters) %>%
  group_by(name) %>% 
  mutate(scaled=scale(value)) %>%
  ggplot(aes(x=clusters,y=name, fill=scaled)) +
  geom_tile() + 
  scale_fill_distiller(palette = "RdYlBu") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45,hjust=1)) 

ggsave(p1,filename = "/work_dir/results/figures/treated/scvelo_velocity_confidence_summarized.png",width = 7,height = 3)
```



```{python}
x, y = scv.utils.get_cell_transitions(sc_treated, basis='umap', starting_cell=0,random_state=1)
ax = scv.pl.velocity_graph(sc_treated, c='lightgrey', edge_width=.05, show=False)
ax = scv.pl.scatter(sc_treated, x=x, y=y, s=120, c='ascending', cmap='gnuplot', ax=ax,save="cell_fate.png")

```


```{python}
scv.tl.velocity_pseudotime(sc_treated)
scv.pl.scatter(sc_treated, color='velocity_pseudotime', cmap='gnuplot',save="velocity_pseudotime.png")

```


```{python}
top_genes = sc_treated.var['fit_likelihood'].sort_values(ascending=False).index[:300]
scv.pl.heatmap(sc_treated, var_names=top_genes, sortby='velocity_pseudotime', col_color='clusters',
n_convolve=100,save="pseudotime_heatmap.png")
```

```{python}
var_names = ['ENSG00000089692.9', 'ENSG00000131196.18', 'NSG00000126709.16']
# LAG3 ,NFATC1,IFI6
scv.pl.scatter(sc_treated, x='velocity_pseudotime', y=var_names, frameon=False,save="gene_plotter.png")

```



```{python}
# this is needed due to a current bug - bugfix is coming soon.
sc_treated.uns['neighbors']['distances'] = sc_treated.obsp['distances']
sc_treated.uns['neighbors']['connectivities'] = sc_treated.obsp['connectivities']

scv.tl.paga(sc_treated, groups='clusters')
df = scv.get_df(sc_treated, 'paga/transitions_confidence', precision=2).T
df.style.background_gradient(cmap='Blues').format('{:.2g}')

scv.pl.paga(sc_treated, basis='umap', size=50, alpha=.1,
            min_edge_width=2, node_size_scale=1.5,save="paga_velocity.png")
```




## Cell rank

```{python}
from cellrank.tl.kernels import VelocityKernel
vk = VelocityKernel(sc_treated)
vk.compute_transition_matrix()
print(vk)

from cellrank.tl.kernels import ConnectivityKernel
ck = ConnectivityKernel(sc_treated).compute_transition_matrix()

combined_kernel = 0.8 * vk + 0.2 * ck
from cellrank.tl.estimators import GPCCA

g = GPCCA(combined_kernel)
print(g)
g.compute_schur(n_components=20)
g.plot_spectrum(save="cellrank_schur_untreated.png")

g.compute_macrostates(n_states=4, cluster_key="clusters")
g.plot_macrostates(save="cellrank_macrostates.png")
g.plot_macrostates(same_plot=False,save="cellrank_macrostates_sep.png")
g.plot_macrostates(discrete=True,save="cellrank_macrostates_discrete.png")


```

```{python}
g.set_terminal_states_from_macrostates()
g.compute_absorption_probabilities()
g.plot_absorption_probabilities(save="cellrank_untreated_absorption_probabilities.png")

g.compute_absorption_probabilities(time_to_absorption="all")
sc_treated.obs["mean_time_to_absorption"] = g.absorption_times['Cluster_Exhausted_2, Cluster_Exhausted_1, Cluster_Naive_like_2_SC, Cluster_Cytotoxic, Cluster_Type_I_IFN mean']
scv.pl.scatter(sc_treated, color="mean_time_to_absorption",save="cellrank_absorption_time_untreated.png")

```



```{python}
cr.pl.circular_projection(sc_treated, keys="clusters", legend_loc="right",save="cellrank_circular_projection.png")
```



## scVelo - Complete dataset {.tabset}


# Run scVelo - combined dataset
```{python}
sc.settings.figdir = 'results/Manuscript/Figure3/'
scv.settings.figdir = 'results/Manuscript/Figure3/'
cr.settings.figdir = 'results/Manuscript/Figure3/'
scv.settings.set_figure_params('scvelo') 
cr.settings.set_figure_params('scvelo') 

```




```{python}
import pandas as pd

GEX1 = anndata.read('/work_dir/results/preprocessing_velocity/kb_count/GEX1/counts_unfiltered/adata.h5ad')
GEX2 = anndata.read('/work_dir/results/preprocessing_velocity/kb_count/GEX2/counts_unfiltered/adata.h5ad')
GEX3 = anndata.read('/work_dir/results/preprocessing_velocity/kb_count/GEX3/counts_unfiltered/adata.h5ad')
GEX4 = anndata.read('/work_dir/results/preprocessing_velocity/kb_count/GEX4/counts_unfiltered/adata.h5ad')

GEX1.obs['sample'] = 'S1'
GEX2.obs['sample'] = 'S2'
GEX3.obs['sample'] = 'S3'
GEX4.obs['sample'] = 'S4'

GEX1.obs['bcs'] = GEX1.obs.index
GEX2.obs['bcs'] = GEX2.obs.index
GEX3.obs['bcs'] = GEX3.obs.index
GEX4.obs['bcs'] = GEX4.obs.index

GEX1.obs.index = GEX1.obs['sample'] + "_" + GEX1.obs['bcs']  + "-1"
GEX2.obs.index = GEX2.obs['sample'] + "_" + GEX2.obs['bcs']  + "-1"
GEX3.obs.index = GEX3.obs['sample'] + "_" + GEX3.obs['bcs']  + "-1"
GEX4.obs.index = GEX4.obs['sample'] + "_" + GEX4.obs['bcs']  + "-1"

sc_combi_1 = GEX1.concatenate(GEX2,index_unique=None)
sc_combi_2 = GEX3.concatenate(GEX4,index_unique=None)

sc_combi = sc_combi_1.concatenate(sc_combi_2,index_unique=None)


scv.pl.proportions(sc_combi,save="scvelo_prop.png")


# filter for cell IDs from seurat 
sample_obs_combi = pd.read_csv("/work_dir/results/exports/seurat_combined/cellID_obs.csv")

sc_combi = sc_combi[np.in1d(sc_combi.obs.index,sample_obs_combi["x"])].copy()
sc_combi

```



```{python}
# add UMAP coordinates
umap_combi = pd.read_csv("/work_dir/results/exports/seurat_combined/cell_embeddings.csv")

sc_combi.obsm['X_umap'] = umap_combi.iloc[:,1:].values

# add cluster info
cluster_combi = pd.read_csv("/work_dir/results/exports/seurat_combined/clusters.csv")
sc_combi.obs['clusters'] = cluster_combi.iloc[:,1:].values

sc.pl.embedding(sc_combi,basis='umap',color ="clusters",save="_scvelo_clusters.png") 
scv.pl.proportions(sc_combi,save="prop_cluster.png")

```


```{r}
p1 <- py$sc_combi$obs  %>% as_tibble(rownames = "cell_ids")  %>%
  mutate(UMAP1=py$sc_combi$obsm$X_umap[,1],
         UMAP2=py$sc_combi$obsm$X_umap[,2]) %>%
  mutate(clusters=as.factor(py$sc_combi$obs$clusters)) %>%
  ggplot(aes(UMAP1,UMAP2,color=clusters)) +
  geom_point(size=.5) +
  theme_classic() +
  scale_color_manual(values = pals::cols25()) +
  guides(color = guide_legend(override.aes = list(size = 2) )) 

ggsave(plot = p1,width = 10,height = 6,filename = "/work_dir/results/figures/combined/umap_scvelo_clusters.png")
p1


p2 <- py$sc_combi$obs  %>% as_tibble(rownames = "cell_ids")  %>%
  mutate(UMAP1=py$sc_combi$obsm$X_umap[,1],
         UMAP2=py$sc_combi$obsm$X_umap[,2]) %>%
  mutate(clusters=as.factor(py$sc_combi$obs$clusters)) %>%
  ggplot(aes(UMAP1,UMAP2,color=sample)) +
  geom_point(size=.5) +
  theme_classic() +
  scale_color_manual(values = pals::cols25()) +
  guides(color = guide_legend(override.aes = list(size = 2) )) 

ggsave(plot = p2,width = 10,height = 6,filename = "/work_dir/results/figures/combined/umap_scvelo_samples.png")
p2



p3 <- py$sc_combi$obs  %>% as_tibble(rownames = "cell_ids")  %>%
  mutate(UMAP1=py$sc_combi$obsm$X_umap[,1],
         UMAP2=py$sc_combi$obsm$X_umap[,2]) %>%
  mutate(clusters=as.factor(py$sc_combi$obs$clusters)) %>%
  group_by(clusters,sample) %>%
  tally() %>%
  ggplot(aes(clusters,n,fill=sample)) +
  geom_bar(stat="identity",position = "dodge") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45,hjust=1)) +
  scale_fill_manual(values = pals::cols25())  

ggsave(plot = p3,width = 10,height = 6,filename = "/work_dir/results/figures/combined/clusters.png")
p3


p4 <- py$sc_combi$obs  %>% as_tibble(rownames = "cell_ids")  %>%
  mutate(UMAP1=py$sc_combi$obsm$X_umap[,1],
         UMAP2=py$sc_combi$obsm$X_umap[,2]) %>%
  mutate(clusters=as.factor(py$sc_combi$obs$clusters)) %>%
  group_by(clusters,sample) %>%
  tally() %>%
  ggplot(aes(clusters,n,fill=sample)) +
  geom_bar(stat="identity",position = "fill") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45,hjust=1)) +
  scale_fill_manual(values = pals::cols25())  +
  scale_y_continuous(labels = scales::percent) +
  labs(y="Percentage of cluster")

ggsave(plot = p4,width = 10,height = 6,filename = "/work_dir/results/figures/combined/clusters_perc.png")
p4




```




```{python}
# conda install pandas=1.3.5
scv.pp.filter_and_normalize(sc_combi)
sc_combi
scv.pp.moments(sc_combi)
sc_combi
scv.tl.recover_dynamics(sc_combi)
scv.tl.velocity(sc_combi, mode = "dynamical")
scv.tl.velocity_graph(sc_combi)


```



```{python}
# save velocity data
sc_combi.write('/work_dir/results/exports/seurat_combined/sc_combi_velocity.h5ad')
#sc_combi = anndata.read('/work_dir/results/exports/seurat_combined/sc_combi_velocity.h5ad')


```

```{python}
scv.pl.velocity_embedding_stream(sc_combi, basis = 'umap',color="clusters",
                                 legend_fontsize=6,min_mass=3, density=3 , save="umap_velocity.png")

scv.pl.velocity_embedding_grid(sc_combi, basis='umap', color="clusters",
                               legend_fontsize=6,min_mass=3, arrow_length =2 ,save="umap_velocity_grid.png")


```



```{python}

scv.pl.velocity_embedding(sc_combi, arrow_length=3, arrow_size=2, dpi=300,save="velocity_embedding.png")


```


```{python}

scv.pl.velocity(sc_combi, ['ENSG00000126709.16'], ncols=2,save="/work_dir/results/figures/combined/gene_dynamics.png")

scv.pl.scatter(sc_combi, 'ENSG00000126709.16', color=['clusters', 'velocity'],
               add_outline='Type_I_IFN, Cytotoxic', save="/work_dir/results/figures/combined/gene_dynamics_ifi6.png")

```

```{python}
scv.tl.rank_velocity_genes(sc_combi, groupby='clusters', min_corr=.3)

df = scv.DataFrame(sc_combi.uns['rank_velocity_genes']['names'])
df["Cluster_Type_I_IFN"].head(5)

```




```{r}
gene_anno <- read_tsv(file = "/work_dir/results/preprocessing_velocity/kb_ref/t2g.txt",
                      col_names = c("transcript_id","gene_id","gene_symbol")) %>% select(2:3) %>% distinct() 

gene_anno <- data.frame(row.names = gene_anno$gene_id,symbol=gene_anno$gene_symbol)


combi_gene_dynamics <- py$df
rownames(combi_gene_dynamics) <- 1:nrow(combi_gene_dynamics)

combi_gene_dynamics_anno <- as.data.frame(lapply(combi_gene_dynamics, function(x) gene_anno[match(x,rownames(gene_anno)),"symbol"]))

```

```{python}
kwargs = dict(frameon=False, size=10, linewidth=1.5,
              add_outline='Type_I_IFN, Cytotoxic')

ifn_to_plot = ["ENSG00000147443.13","ENSG00000109943.9","ENSG00000162692.12","ENSG00000117090.15","ENSG00000125726.11","ENSG00000137265.15","ENSG00000163599.17"]
# DOK2, CRTAM, VCAM1,SLAMF1, CD70, IRF4, CTLA4

scv.pl.scatter(sc_combi, ifn_to_plot, ylabel='Type_I_IFN', **kwargs,save="gene_dynamics_Type_I_IFN.png")
```


```{python}
scv.tl.velocity_confidence(sc_combi)
keys = 'velocity_length', 'velocity_confidence'
scv.pl.scatter(sc_combi, c=keys, cmap='coolwarm', perc=[5, 95], save="velocity_confidence.png")

df = sc_combi.obs.groupby('clusters')[keys].mean().T
```




```{r,fig.width=10,fig.height=3}
p1 <- py$sc_combi$obs %>% as_tibble() %>% 
  select(clusters,velocity_length, velocity_confidence) %>%
  group_by(clusters) %>%
  summarise(across(everything(),mean)) %>%
  pivot_longer(cols = -clusters) %>%
  group_by(name) %>% 
  mutate(scaled=scale(value)) %>%
  ggplot(aes(x=clusters,y=name, fill=scaled)) +
  geom_tile() + 
  scale_fill_distiller(palette = "RdYlBu") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45,hjust=1)) 

ggsave(p1,filename = "/work_dir/results/figures/combined/velocity_confidence_summarized.png",width = 7,height = 3)
```



```{python}
x, y = scv.utils.get_cell_transitions(sc_combi, basis='umap', starting_cell=0,random_state=1)
ax = scv.pl.velocity_graph(sc_combi, c='lightgrey', edge_width=.05, show=False)
ax = scv.pl.scatter(sc_combi, x=x, y=y, s=120, c='ascending', cmap='gnuplot', ax=ax,save="cell_fate.png")

```


```{python}
scv.tl.velocity_pseudotime(sc_combi)
scv.pl.scatter(sc_combi, color='velocity_pseudotime', cmap='gnuplot',save="velocity_pseudotime.png")

```


```{python}
top_genes = sc_combi.var['fit_likelihood'].sort_values(ascending=False).index[:300]
scv.pl.heatmap(sc_combi, var_names=top_genes, sortby='velocity_pseudotime', col_color='clusters',
               n_convolve=100,save="pseudotime_heatmap.png")
```

```{python}
#var_names = ['ENSG00000089692.9', 'ENSG00000131196.18', 'NSG00000126709.16']
# LAG3 ,NFATC1,IFI6
#scv.pl.scatter(sc_combi, x='velocity_pseudotime', y=var_names, frameon=False,save="gene_plotter.png")

```



```{python}
# this is needed due to a current bug - bugfix is coming soon.
sc_combi.uns['neighbors']['distances'] = sc_combi.obsp['distances']
sc_combi.uns['neighbors']['connectivities'] = sc_combi.obsp['connectivities']

scv.tl.paga(sc_combi, groups='clusters')
df = scv.get_df(sc_combi, 'paga/transitions_confidence', precision=2).T
df.style.background_gradient(cmap='Blues').format('{:.2g}')

scv.pl.paga(sc_combi, basis='umap', size=50, alpha=.1,
            min_edge_width=2, node_size_scale=1.5,save="paga_velocity.png")
```




## Cell rank

```{python}
from cellrank.tl.kernels import VelocityKernel
vk = VelocityKernel(sc_combi)
vk.compute_transition_matrix()
print(vk)

from cellrank.tl.kernels import ConnectivityKernel
ck = ConnectivityKernel(sc_combi).compute_transition_matrix()

combined_kernel = 0.8 * vk + 0.2 * ck
from cellrank.tl.estimators import GPCCA

g = GPCCA(combined_kernel)
print(g)
g.compute_schur(n_components=20)
g.plot_spectrum(save="cellrank_schur_untreated.png")

g.compute_macrostates(n_states=4, cluster_key="clusters")
g.plot_macrostates(save="cellrank_macrostates.png")
g.plot_macrostates(same_plot=False,save="cellrank_macrostates_sep.png")
g.plot_macrostates(discrete=True,save="cellrank_macrostates_discrete.png")


```

```{python}
g.set_terminal_states_from_macrostates()
g.compute_absorption_probabilities()
g.plot_absorption_probabilities(save="cellrank_untreated_absorption_probabilities.png")

g.compute_absorption_probabilities(time_to_absorption="all")
sc_combi.obs["mean_time_to_absorption"] = g.absorption_times['Cluster_Exhausted_2, Cluster_Exhausted_1, Cluster_Naive_like_2_SC, Cluster_Cytotoxic, Cluster_Type_I_IFN mean']
scv.pl.scatter(sc_combi, color="mean_time_to_absorption",save="cellrank_absorption_time_untreated.png")

```



```{python}
cr.pl.circular_projection(sc_combi, keys="clusters", legend_loc="right",save="cellrank_circular_projection.png")
```



