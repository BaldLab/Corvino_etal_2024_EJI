---
title: "08_Manuscript_Figure_6"
author: "Dillon Corvino"
date: "07/03/2022"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: united
    highlight: tango
    df_print: paged
    code_folding: hide
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
---

Built with R version `{r} getRversion()`

## Setup {.tabset}

### Environment

```{r setup, message = FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,  
  eval = TRUE, 
  tidy = TRUE
)

knitr::opts_knit$set(
  root.dir = "../"
)

# Environment Set up
rm(list = ls()) #Clean workspace
cat("\014")     #Clean Console
gc() # Free memory


# Establish working directory
library("rstudioapi")

# Set working directory to source file location
setwd(dirname(getActiveDocumentContext()$path))
setwd("..")

# Create output directories & load custom functions & colour scheme
source("scripts/Setup.R", local = knitr::knit_global())

# pipeline variables
long.compute <- FALSE
quick.load <- TRUE

# load required packages
require(tidyverse)
require(Seurat)


# Create output directory
output.dir <- "results/Manuscript/Figure_6/"

if(!dir.exists(paste0(output.dir))){
  dir.create(paste0(output.dir), 
             recursive = TRUE)
}



if(quick.load){
  
  # full dataset reduced to just GZMK, ISG, Stim-1 clusters
  reduced.seurat <- LoadH5Seurat("saves/reduced_seurat.h5Seurat")
  
  Idents(reduced.seurat) <- reduced.seurat@meta.data$Clusters_l1
  DefaultAssay(reduced.seurat) <- "integrated"
  
  # TCR dataset with GZMK, ISG, Stim-1 clusters and new umap calculated using full dataset
  reduced.seurat.tcr <- LoadH5Seurat("saves/reduced_seurat_tcr.h5Seurat")
  
  Idents(reduced.seurat.tcr) <- reduced.seurat.tcr@meta.data$Clusters_l1
  DefaultAssay(reduced.seurat.tcr) <- "integrated"
}

```


# TO DO
# create new umap projection with just ISG, GZMK, and Stim-1
# apply umap co-ords across tcr and full datasets
# perform trajectory and output results for traj on full dataset
# unique ISG clones and GZMK clones on new umap projection 
# deg, heatmap etc, these three datasets. 
# vis memory, helper, cyto, functions of ISG cluster

### subsetting seurat object to include just GZMK, ISG, and Stim-1 clusters
```{r reducing_seurat_object}
if(long.compute){
  ################################################
  # Subset dataset and recalculate UMAP
  ################################################
  
  CD8.seurat <- LoadH5Seurat("saves/CD8_seurat.h5Seurat")
  
  Idents(CD8.seurat) <- CD8.seurat@meta.data$Clusters_l1
  DefaultAssay(CD8.seurat) <- "integrated"
  reduced.seurat <- subset(CD8.seurat, idents = c("GZMK", "ISG", "Stimulated_1"))
  
  # calculate dim reduction using reduced dataset
  reduced.seurat <- Seurat::RunPCA(reduced.seurat)
  reduced.seurat <- Seurat::RunUMAP(object = reduced.seurat,
                                    reduction = "pca",
                                    dims = 1:20,
                                    umap.method = "uwot",
                                    n.neighbors = 30, # 5 to 50
                                    min.dist = 0.5, # Sensible values are in the range 0.001 to 0.5
                                    seed.use = 42)
  
  UMAPPlot(reduced.seurat,
           group.by = "Clusters_l1", 
           label = TRUE, 
           pt.size = 1) + NoLegend()
  
  dev.copy(pdf, paste0(output.dir, "UMAP_reduced_dataset.pdf"))
  dev.off()
  
  # Save the seurat object
  SaveH5Seurat(reduced.seurat,
               "saves/reduced_seurat.h5Seurat",
               overwrite = TRUE)
  
  # Load tcr seurat and append umap dims with tcr seurat 
  CD8.seurat.tcr <- LoadH5Seurat("saves/CD8_seurat_tcr.h5Seurat")
  
  # reduce tcr object
  Idents(CD8.seurat.tcr) <- CD8.seurat.tcr@meta.data$Clusters_l1
  reduced.seurat.tcr <- subset(CD8.seurat.tcr, idents = c("GZMK", "ISG", "Stimulated_1"))
  
  
  # extract vector of cells to keep
  cells.keep <- colnames(reduced.seurat.tcr)
  
  # extract TCR dimensions from reduced seurat object
  temp.seurat <- subset(reduced.seurat, cells = cells.keep)
  
  DefaultAssay(reduced.seurat.tcr) <- "integrated"
  reduced.seurat.tcr[["umap"]] <- Seurat::CreateDimReducObject(embeddings = temp.seurat@reductions$umap@cell.embeddings, key = "UMAP_", assay = DefaultAssay(reduced.seurat.tcr))
  
  
  UMAPPlot(reduced.seurat.tcr,
           group.by = "Clusters_l1", 
           label = TRUE, 
           pt.size = 1) + NoLegend()
  
  dev.copy(pdf, paste0(output.dir, "UMAP_reduced_dataset_tcrdataset.pdf"))
  dev.off()
  
  
  # Save the seurat object
  SaveH5Seurat(reduced.seurat.tcr,
               "saves/reduced_seurat_tcr.h5Seurat",
               overwrite = TRUE)
  
  rm(temp.seurat, CD8.seurat, CD8.seurat.tcr)
}

```

### Figure 6A
```{r figure_6A}


Idents(reduced.seurat) <- reduced.seurat@meta.data$Clusters_l1
DefaultAssay(reduced.seurat) <- "RNA"

GZMK.vs.Stim.markers <- FindMarkers(reduced.seurat, 
                                    ident.1 = "GZMK",
                                    ident.2 = "Stimulated_1",
                                    logfc.threshold = 0.25, 
                                    min.pct = 0.1, 
                                    test.use = "wilcox")



GZMK.vs.Stim.markers <- GZMK.vs.Stim.markers %>%
  dplyr::filter(p_val_adj < 0.05) %>%
  dplyr::arrange(desc(avg_log2FC))



GZMK.vs.Stim.markers %>%
  top_n(30, avg_log2FC)



VlnPlot_scCustom(reduced.seurat, features = "PTPRC")




```



### Figure 6C
```{r Figure_6C}

# UMAP projection of reduced subset 

cols.vec <- clust.cols[names(clust.cols) %in% c("ISG", "GZMK", "Stimulated_1")]



UMAPPlot(reduced.seurat,
         group.by = "Clusters_l1", 
         cols = cols.vec,
         label = TRUE, 
         pt.size = 1) + NoLegend()

dev.copy(pdf, paste0(output.dir, "UMAP_Stim_1_GZMK_ISG_clusters_only.pdf"))
dev.off()

UMAPPlot(reduced.seurat,
         group.by = "Clusters_l1", 
         split.by = "condition",
         cols = cols.vec,
         label = TRUE, 
         pt.size = 1) + NoLegend()

dev.copy(pdf, paste0(output.dir, "UMAP_Stim_1_GZMK_ISG_clusters_only_splitby_condition.pdf"))
dev.off()



```


### Identify unique clones in US GZMK and ISG clusters
```{r Identify_unique_clones}

####################################################################################
# Identify clones that are uniquely found only in US ISG cluster
####################################################################################

# Clone size minimum 
clonesize.min <- 3

# Get clonotypes found in US-ISG that are shared across conditions
ISG.clonotypes <- reduced.seurat.tcr@meta.data %>%
  dplyr::filter(Total_clonotype_n > clonesize.min) %>%
  dplyr::select(CTaa, Clusters_l1, condition, Clonotype_overlap) %>%
  dplyr::filter(Clonotype_overlap == "Shared" & condition == "US") %>%
  dplyr::filter(Clusters_l1 == "ISG") %>%
  dplyr::distinct(CTaa) %>%
  dplyr::pull(CTaa)

length(ISG.clonotypes) # 53 clonotypes 

# Cross reference to identify which of the above clones can be found elsewehre within the US dataset
non.specific.clonotypes <- reduced.seurat.tcr@meta.data %>%
  dplyr::filter(Total_clonotype_n > clonesize.min) %>%
  dplyr::filter(Clonotype_overlap == "Shared" & condition == "US") %>%
  dplyr::filter(CTaa %in% ISG.clonotypes) %>%
  dplyr::filter(Clusters_l1 != "ISG") %>%
  dplyr::distinct(CTaa) %>%
  dplyr::pull(CTaa)

length(non.specific.clonotypes) # 27 clonotypes 
# therefore 26 ISG specific clonotypes 

# Use non.specific.clonotypes list to identify unique.clonotypes
logic.vec <- ISG.clonotypes %in% non.specific.clonotypes
unique.ISG.clones <- ISG.clonotypes[!logic.vec]

length(unique.ISG.clones) # 26 clonotypes 


# create metadata identifying unique and non-unique clones
meta.data.temp <- reduced.seurat.tcr@meta.data %>%
  dplyr::mutate(ISG_unique = case_when(CTaa %in% unique.ISG.clones ~ "unique", 
                                       CTaa %in% non.specific.clonotypes ~ "nonunique",
                                       .default = "nonISG")) %>%
  dplyr::select(ISG_unique)

# Append metadata to seurat object
reduced.seurat.tcr <- AddMetaData(object = reduced.seurat.tcr, 
                                  col.name = "ISG_unique",
                                  metadata = meta.data.temp)


Idents(reduced.seurat.tcr) <- reduced.seurat.tcr@meta.data$condition
temp.seurat <- subset(reduced.seurat.tcr, idents = "US")
UMAPPlot(temp.seurat, 
         group.by = "Clusters_l1", 
         split.by = "ISG_unique",
         pt.size = 2)


## Key info 
# Unique US-ISG clones = 27 clones across 60 cells in US dataset and 131 cells in stim dataset
table(reduced.seurat.tcr@meta.data$ISG_unique, reduced.seurat.tcr@meta.data$condition)

# quick look at clonotype characteristics 
temp.meta <- reduced.seurat.tcr@meta.data %>%
  dplyr::filter(Clonotype_overlap == "Shared" & condition == "US") %>%
  dplyr::filter(CTaa %in% unique.ISG.clones) %>%
  distinct(CTaa, .keep_all = TRUE)

table(temp.meta$cloneType) # most clones are small size within US dataset


reduced.seurat.tcr@meta.data %>%
  dplyr::filter(Clonotype_overlap == "Shared" & condition == "Stim") %>%
  dplyr::filter(CTaa %in% "CADDRGSTLGRLYF_CASSHETSLQRYEQYF")

scCustomize::Meta_Highlight_Plot(reduced.seurat.tcr, 
                                 split.by = "Clusters_l1",
                                 meta_data_column = "CTaa", 
                                 meta_data_highlight = "CADDRGSTLGRLYF_CASSHETSLQRYEQYF") + NoLegend() + ggtitle(paste0("CADDRGSTLGRLYF_CASSHETSLQRYEQYF"))


####################################################################################
# Identify clones that are uniquely found only in US GZMK cluster
####################################################################################

# Clone size minimum 
clonesize.min <- 3

# Get clonotypes found in US-ISG that are shared across conditions
GZMK.clonotypes <- reduced.seurat.tcr@meta.data %>%
  dplyr::filter(Total_clonotype_n > clonesize.min) %>%
  dplyr::select(CTaa, Clusters_l1, condition, Clonotype_overlap) %>%
  dplyr::filter(Clonotype_overlap == "Shared" & condition == "US") %>%
  dplyr::filter(Clusters_l1 == "GZMK") %>%
  dplyr::distinct(CTaa) %>%
  dplyr::pull(CTaa)

length(GZMK.clonotypes) # 80 clonotypes 

# Cross reference to identify which of the above clones can be found elsewehre within the US dataset
non.specific.clonotypes <- reduced.seurat.tcr@meta.data %>%
  dplyr::filter(Total_clonotype_n > clonesize.min) %>%
  dplyr::filter(Clonotype_overlap == "Shared" & condition == "US") %>%
  dplyr::filter(CTaa %in% GZMK.clonotypes) %>%
  dplyr::filter(Clusters_l1 != "GZMK") %>%
  dplyr::distinct(CTaa) %>%
  dplyr::pull(CTaa)

length(non.specific.clonotypes) # 27 clonotypes 
# therefore 53 GZMK specific clonotypes 

# Use non.specific.clonotypes list to identify unique.clonotypes
logic.vec <- GZMK.clonotypes %in% non.specific.clonotypes
unique.GZMK.clones <- GZMK.clonotypes[!logic.vec]

length(unique.GZMK.clones) # 53 clonotypes 


# create metadata identifying unique and non-unique clones
meta.data.temp <- reduced.seurat.tcr@meta.data %>%
  dplyr::mutate(GZMK_unique = case_when(CTaa %in% unique.GZMK.clones ~ "unique", 
                                        CTaa %in% non.specific.clonotypes ~ "nonunique",
                                        .default = "nonGZMK")) %>%
  dplyr::select(GZMK_unique)

# Append metadata to seurat object
reduced.seurat.tcr <- AddMetaData(object = reduced.seurat.tcr, 
                                  col.name = "GZMK_unique",
                                  metadata = meta.data.temp)


Idents(reduced.seurat.tcr) <- reduced.seurat.tcr@meta.data$condition
temp.seurat <- subset(reduced.seurat.tcr, idents = "US")
UMAPPlot(temp.seurat, 
         group.by = "Clusters_l1", 
         split.by = "GZMK_unique",
         pt.size = 2)


## Key info 
# Unique US-GZMK clones = 53 clones across 169 cells in US dataset and 143 cells in stim dataset
table(reduced.seurat.tcr@meta.data$GZMK_unique, reduced.seurat.tcr@meta.data$condition)

# quick look at clonotype characteristics 
temp.meta <- reduced.seurat.tcr@meta.data %>%
  dplyr::filter(Clonotype_overlap == "Shared" & condition == "US") %>%
  dplyr::filter(CTaa %in% unique.GZMK.clones) %>%
  distinct(CTaa, .keep_all = TRUE)

table(temp.meta$cloneType) # most clones are small size within US dataset


# add together GZMK and ISG unique annotations into one column for plotting together on one graph 
# reduce dataset to only US

meta.data.temp <- reduced.seurat.tcr@meta.data %>%
  dplyr::mutate(unique_ident = case_when(CTaa %in% unique.GZMK.clones ~ "GZMK_unique", 
                                         CTaa %in% unique.ISG.clones ~ "ISG_unique",
                                         .default = "other")) %>%
  dplyr::select(unique_ident)

# Append metadata to seurat object
reduced.seurat.tcr <- AddMetaData(object = reduced.seurat.tcr, 
                                  col.name = "unique_ident",
                                  metadata = meta.data.temp)

reduced.seurat.tcr@meta.data$unique_ident <- factor(reduced.seurat.tcr@meta.data$unique_ident, 
                                                    levels = c("ISG_unique", "GZMK_unique", "other"))

# subset dataset by condition to make two plots. plotting looks nicer when split and not using the split.by variable 
# use xlim and ylim to keep axis dims same across datasets
# note, plotting performed like this to ensure a bunch of "other" cells keept in dataset that can be put as background to help orientate the cluster positions etc

Idents(reduced.seurat.tcr) <- reduced.seurat.tcr@meta.data$condition
US.reduced.tcr.seurat <- subset(reduced.seurat.tcr, idents = "US")

# Plot US dataset
UMAPPlot(US.reduced.tcr.seurat, 
         group.by = "unique_ident", 
         pt.size = 3, 
         order = c("ISG_unique", "GZMK_unique", "other"), 
         cols = c("#BEBEBE33", "#666666", "#A6D854")) + 
  NoLegend() + 
  ggtitle("Unique ISG and GZMK clones in US") + 
  xlim(-8,6.5) + 
  ylim(-5.5, 7)

dev.copy(pdf, paste0(output.dir, "Figure_6C.pdf"))
dev.off()


# to show after stim clone positions first subset by stim 
Idents(reduced.seurat.tcr) <- reduced.seurat.tcr@meta.data$condition
Stim.reduced.tcr.seurat <- subset(reduced.seurat.tcr, idents = "Stim")


# Next subset by ISG unique and other
Idents(Stim.reduced.tcr.seurat) <- Stim.reduced.tcr.seurat@meta.data$unique_ident
ISG.seurat <- subset(Stim.reduced.tcr.seurat, idents = c("ISG_unique", "other"))


# define new metadata that identifies the cluster ISG_unique cells belong to after stimulation
meta.data.temp <- ISG.seurat@meta.data %>%
  mutate(destination_id = case_when(unique_ident == "ISG_unique" ~ Clusters_l1, 
                                    .default = "other")) %>%
  dplyr::select(destination_id)

# Append metadata to seurat object
ISG.seurat <- AddMetaData(object = ISG.seurat, 
                          col.name = "destination_id",
                          metadata = meta.data.temp)



# Plot ISG unique
UMAPPlot(ISG.seurat, 
         group.by = "destination_id", 
         pt.size = 3, 
         order = c("GZMK", "ISG", "Stimulated_1", "other"),
         cols = rev(c("#666666", "#A6D854", "#984EA3", "#BEBEBE33"))) +
  NoLegend() + 
  ggtitle("Unique ISG clones") + 
  xlim(-8, 6.5) + 
  ylim(-5.5, 7)

dev.copy(pdf, paste0(output.dir, "Figure_6D.pdf"))
dev.off()




###################################################
# Next subset by GZMK unique and other
###################################################

Idents(Stim.reduced.tcr.seurat) <- Stim.reduced.tcr.seurat@meta.data$unique_ident
GZMK.seurat <- subset(Stim.reduced.tcr.seurat, idents = c("GZMK_unique", "other"))


# define new metadata that identifies the cluster ISG_unique cells belong to after stimulation
meta.data.temp <- GZMK.seurat@meta.data %>%
  mutate(destination_id = case_when(unique_ident == "GZMK_unique" ~ Clusters_l1,
                                    .default = "other")) %>%
  dplyr::select(destination_id)

# Append metadata to seurat object
GZMK.seurat <- AddMetaData(object = GZMK.seurat, 
                           col.name = "destination_id",
                           metadata = meta.data.temp)



# Plot GZMK unique
UMAPPlot(GZMK.seurat, 
         group.by = "destination_id", 
         pt.size = 3, 
         order = c("GZMK", "ISG", "Stimulated_1", "other"),
         cols = rev(c("#666666", "#A6D854", "#984EA3", "#BEBEBE33"))) +
  NoLegend() + 
  ggtitle("Unique GZMK clones") + 
  xlim(-8, 6.5) + 
  ylim(-5.5, 7)

dev.copy(pdf, paste0(output.dir, "Figure_6E.pdf"))
dev.off()


```

```{r clone_movememnt_stats}

## Statsitics of clone movement after stimulation 

########################
# stats by clonotype 
########################

# Firstly subset data by Stim only, and reduce to clonotype by cluster level
# i.e keep only one entry per clonotype per cluster
clonotype.data <- reduced.seurat.tcr@meta.data %>%
  dplyr::filter(condition == "Stim") %>%
  dplyr::distinct(CTaa, Clusters_l1, .keep_all = T)

########################
# Unique ISG clones
########################

clone.distribution.df <- table(clonotype.data$ISG_unique, clonotype.data$Clusters_l1)
clone.distribution.df

# calculate number of clones in each catagory (unique, non-unique, etc)
sum.val <- rowSums(clone.distribution.df)

# divide each cluster clone # by the sum value of clones for that category 
clone.distribution.df <- sweep(clone.distribution.df, 1, 
                               sum.val, 
                               FUN = "/")

clone.distribution.df <- clone.distribution.df*100
clone.distribution.df

# sanity check
rowSums(clone.distribution.df)

write.csv(clone.distribution.df, paste0(output.dir, "unique_US_ISG_clonetypes_distribution_after_stimulation_freq.csv"))

########################
# Unique GZMK clones
########################
clone.distribution.df <- table(clonotype.data$GZMK_unique, clonotype.data$Clusters_l1)
clone.distribution.df

# calculate number of clones in each catagory (unique, non-unique, etc)
sum.val <- rowSums(clone.distribution.df)

# divide each cluster clone # by the sum value of clones for that category 
clone.distribution.df <- sweep(clone.distribution.df, 1, 
                               sum.val, 
                               FUN = "/")

clone.distribution.df <- clone.distribution.df*100
clone.distribution.df

# sanity check
rowSums(clone.distribution.df)

write.csv(clone.distribution.df, paste0(output.dir, "unique_US_GZMK_clonetypes_distribution_after_stimulation_freq.csv"))




########################
# stats by cell number 
########################

# Firstly subset data by Stim only, and reduce to clonotype by cluster level
# i.e keep only one entry per clonotype per cluster
cell.number.data <- reduced.seurat.tcr@meta.data %>%
  dplyr::filter(condition == "Stim")

########################
# Unique ISG clones
########################

cell.distribution.df <- table(cell.number.data$ISG_unique, cell.number.data$Clusters_l1)
cell.distribution.df

# calculate number of clones in each catagory (unique, non-unique, etc)
sum.val <- rowSums(cell.distribution.df)

# divide each cluster clone # by the sum value of clones for that category 
cell.distribution.df <- sweep(cell.distribution.df, 1, 
                              sum.val, 
                              FUN = "/")

cell.distribution.df <- cell.distribution.df*100
cell.distribution.df

# sanity check
rowSums(cell.distribution.df)

write.csv(cell.distribution.df, paste0(output.dir, "unique_US_ISG_clonetypes_cell_distribution_after_stimulation_freq.csv"))

########################
# Unique GZMK clones
########################
cell.distribution.df <- table(cell.number.data$GZMK_unique, cell.number.data$Clusters_l1)
cell.distribution.df

# calculate number of clones in each catagory (unique, non-unique, etc)
sum.val <- rowSums(cell.distribution.df)

# divide each cluster clone # by the sum value of clones for that category 
cell.distribution.df <- sweep(cell.distribution.df, 1, 
                              sum.val, 
                              FUN = "/")

cell.distribution.df <- cell.distribution.df*100
cell.distribution.df

# sanity check
rowSums(cell.distribution.df)

write.csv(cell.distribution.df, paste0(output.dir, "unique_US_GZMK_clonetypes_cell_distribution_after_stimulation_freq.csv"))


```

## Pseudotime
```{r pseudotime}

####################################
# Create dir to hold large objects
####################################

save.dir <- "saves/Trajectory/"
  
  if(!dir.exists(paste0(save.dir))){
    dir.create(paste0(save.dir), 
               recursive = T)
  }
  
###########################
# Load packages
###########################

#devtools::install_github("dynverse/dyno")

library(dyno)
library(dynplot)
library(dynmethods)
library(dynutils)
library(dynwrap)
library(tidyverse)
dynwrap::test_docker_installation(detailed = TRUE)

############################
# Read in and prepare data
############################

if(long.compute){  
  
  # Read in dataframes
  raw.data <- as.data.frame(reduced.seurat@assays$RNA@counts)
  normed.data <- as.data.frame(reduced.seurat@assays$RNA@data)
  
  
  # data is organized cols = cells and rows = genes
  head(raw.data[1:10, 1:10])
  head(normed.data[1:10, 1:10])
  
  # Need to inverse data for input into dyno package
  raw.data <- t(raw.data)
  head(raw.data[1:10, 1:10])
  
  normed.data <- t(normed.data)
  head(normed.data[1:10, 1:10])
  
  # Check data structure
  dim(raw.data) # 4,102 cells and 16,295 genes
  dim(normed.data) # 4,102 cells and 16,295 genes
  
  ##########################################
  # Creating Dyno formatted data structure
  ##########################################
  
  Dyno.data <- wrap_expression(counts = raw.data,
                               expression = normed.data)
  
  # Add grouping info
  group.vect <- reduced.seurat@meta.data$Clusters_l1
  names(group.vect) <- colnames(reduced.seurat)
  
  Dyno.data <- add_grouping(Dyno.data,
                            grouping = group.vect)
  
  
  # Add dim reduction
  UMAP.dims <- reduced.seurat@reductions$umap@cell.embeddings
  
  
  Dyno.data <- add_dimred(Dyno.data,
                          dimred = UMAP.dims)
  
  
  
  #####################
  # Infer Trajectory
  #####################
  
  
  ##############
  # Slingshot
  ##############
  
  slingshot <- infer_trajectory(Dyno.data, 
                                method = "dynverse/ti_slingshot:v0.9.9.01", 
                                parameters = NULL, 
                                give_priors = NULL, 
                                seed = set.seed(42),
                                verbose = TRUE)
  
  
  
  saveRDS(slingshot, file = paste0(save.dir, "slingshot.rds"))
  rm(slingshot)
  
}

# Read data
slingshot <- readRDS(paste0(save.dir, "slingshot.rds"))

# Set root milestone
slingshot <- add_root(trajectory = slingshot, 
                        root_milestone_id = "3")

dynplot::plot_dimred(slingshot, 
                     dimred = UMAP.dims,
                     hex_cells = TRUE, 
                     label_milestones = T,
                     color_cells = "pseudotime")


?infer_trajectory








# Cacluate trajectory feature importance

overall_feature_importances <- dynfeature::calculate_overall_feature_importance(slingshot, 
                                                                                expression_source = normed.data)

top.features <- overall_feature_importances %>% 
  top_n(-10, importance) %>% 
  pull(feature_id)


plot_heatmap(slingshot, 
             expression_source = normed.data, 
             features_oi = top.features)

dev.copy(pdf, paste0(output.dir, "Heatmap_top50_important_features.pdf"))
dev.off()


# Calculate milestone importance
for(i in 1:length(slingshot$milestone_ids)){
  
  # Because milestone ids are not in order get the corresponding ID name for each milestone #
  logic.var <- names(slingshot$milestone_labelling) == i
  milestone.name <- paste0(slingshot$milestone_labelling[logic.var])
  
  
  milestone.feature.importance <- calculate_milestone_feature_importance(slingshot,
                                                                         expression_source = normed.data, 
                                                                         milestones_oi = i, 
                                                                         verbose = TRUE)
  
  
  top.features <- milestone.feature.importance %>% 
    top_n(25, importance) %>% 
    pull(feature_id)
  
  print(plot_heatmap(slingshot, 
                     expression_source = normed.data, 
                     features_oi = top.features))
  
  dev.copy(pdf, paste0("output/figures/Trajectories/Slingshot/Combined_heatmap_top25_milestone_", milestone.name, "_important_features.pdf"))
  dev.off()
  
  
}


```






