## Steps to reproduce kb environment
#1. create empty conda environment
conda create env -n 2021_bald_kb
#2. update conda environment with mamba from file
mamba env update -n 2021_bald_kb --file environment_kb.yml
#3. activate conda env
conda activate 2021_bald_kb 
#4. re-install kb-python
pip install kb-python


## Steps to build kallisto index
#0. Download prebuilt index
#kb ref -d human -i human_kallisto_index -g t2g.txt

#1. download required files from gencode

#2. Build reference 
kb ref -i index.idx -g t2g.txt -f1 cdna.fa -f2 intron.fa -c1 cdna_t2c.txt -c2 intron_t2c.txt --workflow lamanno \
GRCh38.primary_assembly.genome.fa.gz \
gencode.v38.primary_assembly.annotation.gtf.gz


## Steps to create count matrices
#1. Merge fastq files 
cd /home/projects/bald/2021_bald_1/data/20200121_BaldNextSeq_HNSCC_AG_BALD/200117_NB551151_0156_AHYMJ3BGXCGEX/NGS170120GEX/
cat SI-GA-A2_*/*R1_*.fastq.gz > GEX1_R1.fastq.gz
cat SI-GA-A2_*/*R2_*.fastq.gz > GEX1_R2.fastq.gz
cat SI-GA-B2_*/*R1_*.fastq.gz > GEX2_R1.fastq.gz
cat SI-GA-B2_*/*R2_*.fastq.gz > GEX2_R2.fastq.gz
cat SI-GA-C2_*/*R1_*.fastq.gz > GEX3_R1.fastq.gz
cat SI-GA-C2_*/*R2_*.fastq.gz > GEX3_R2.fastq.gz
cat SI-GA-D2_*/*R1_*.fastq.gz > GEX4_R1.fastq.gz
cat SI-GA-D2_*/*R2_*.fastq.gz > GEX4_R2.fastq.gz


#cd workflows/velocyto/
kb count --h5ad -i ../../results/preprocessing_velocity/kb_ref/index.idx \
-g ../../results/preprocessing_velocity/kb_ref/t2g.txt \
-x 10xv2 -o ../../results/preprocessing_velocity/kb_count/GEX1 \
-c1 ../../results/preprocessing_velocity/kb_ref/cdna_t2c.txt \
-c2 ../../results/preprocessing_velocity/kb_ref/intron_t2c.txt \
--workflow lamanno --filter bustools -t 8 --overwrite \
../../data/20200121_BaldNextSeq_HNSCC_AG_BALD/200117_NB551151_0156_AHYMJ3BGXCGEX/NGS170120GEX/GEX1_R1.fastq.gz \
../../data/20200121_BaldNextSeq_HNSCC_AG_BALD/200117_NB551151_0156_AHYMJ3BGXCGEX/NGS170120GEX/GEX1_R2.fastq.gz



kb count --h5ad -i ../../results/preprocessing_velocity/kb_ref/index.idx \
-g ../../results/preprocessing_velocity/kb_ref/t2g.txt \
-x 10xv2 -o ../../results/preprocessing_velocity/kb_count/GEX2 \
-c1 ../../results/preprocessing_velocity/kb_ref/cdna_t2c.txt \
-c2 ../../results/preprocessing_velocity/kb_ref/intron_t2c.txt \
--workflow lamanno --filter bustools -t 8 \
../../data/20200121_BaldNextSeq_HNSCC_AG_BALD/200117_NB551151_0156_AHYMJ3BGXCGEX/NGS170120GEX/GEX2_R1.fastq.gz \
../../data/20200121_BaldNextSeq_HNSCC_AG_BALD/200117_NB551151_0156_AHYMJ3BGXCGEX/NGS170120GEX/GEX2_R2.fastq.gz




kb count --h5ad -i ../../results/preprocessing_velocity/kb_ref/index.idx \
-g ../../results/preprocessing_velocity/kb_ref/t2g.txt \
-x 10xv2 -o ../../results/preprocessing_velocity/kb_count/GEX3 \
-c1 ../../results/preprocessing_velocity/kb_ref/cdna_t2c.txt \
-c2 ../../results/preprocessing_velocity/kb_ref/intron_t2c.txt \
--workflow lamanno --filter bustools -t 8 \
../../data/20200121_BaldNextSeq_HNSCC_AG_BALD/200117_NB551151_0156_AHYMJ3BGXCGEX/NGS170120GEX/GEX3_R1.fastq.gz \
../../data/20200121_BaldNextSeq_HNSCC_AG_BALD/200117_NB551151_0156_AHYMJ3BGXCGEX/NGS170120GEX/GEX3_R2.fastq.gz



kb count --h5ad -i ../../results/preprocessing_velocity/kb_ref/index.idx \
-g ../../results/preprocessing_velocity/kb_ref/t2g.txt \
-x 10xv2 -o ../../results/preprocessing_velocity/kb_count/GEX4 \
-c1 ../../results/preprocessing_velocity/kb_ref/cdna_t2c.txt \
-c2 ../../results/preprocessing_velocity/kb_ref/intron_t2c.txt \
--workflow lamanno --filter bustools -t 8 \
../../data/20200121_BaldNextSeq_HNSCC_AG_BALD/200117_NB551151_0156_AHYMJ3BGXCGEX/NGS170120GEX/GEX4_R1.fastq.gz \
../../data/20200121_BaldNextSeq_HNSCC_AG_BALD/200117_NB551151_0156_AHYMJ3BGXCGEX/NGS170120GEX/GEX4_R2.fastq.gz

